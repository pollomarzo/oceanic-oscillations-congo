stages:
- build
- deploy

variables:
  SITE_PREFIX: /$CI_PROJECT_NAME
  # GitLab Pages requires output in 'public' directory
  OUTPUT_DIR: "public"
  BUILD_DIR: "_build/html"

build:
  stage: build
  image: mambaorg/micromamba:latest
  cache:
    paths:
    - .micromamba/
  script:
  - micromamba create -f environment.yml -y
  - eval "$(micromamba shell hook --shell bash)"
  - micromamba activate nexus
  - myst build --html
  - mv $BUILD_DIR $OUTPUT_DIR
  artifacts:
    paths:
    - public
    expire_in: 1 hour
  rules:
  - if: $CI_COMMIT_BRANCH == "main"
  - if: $CI_PIPELINE_SOURCE == "web"

pages:
  stage: deploy
  script:
  - echo "Deploying to GitLab Pages..."
  artifacts:
    paths:
    - public
  rules:
  - if: $CI_COMMIT_BRANCH == "main"
  - if: $CI_PIPELINE_SOURCE == "web"
  needs:
  - build
